<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AR ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå: ‡πÇ‡∏•‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <script>
        AFRAME.registerComponent("gesture-detector", {
            schema: { element: { default: "" } },
            init: function() {
                this.targetElement = this.data.element && document.querySelector(this.data.element);
                if (!this.targetElement) this.targetElement = this.el;
                this.internalState = { previousState: null };
                this.emitGestureEvent = this.emitGestureEvent.bind(this);
                this.targetElement.addEventListener("touchstart", this.emitGestureEvent);
                this.targetElement.addEventListener("touchend", this.emitGestureEvent);
                this.targetElement.addEventListener("touchmove", this.emitGestureEvent);
            },
            emitGestureEvent(event) {
                const currentState = this.getTouchState(event);
                const previousState = this.internalState.previousState;
                const gestureContinues = previousState && currentState && currentState.touchCount == previousState.touchCount;
                if (gestureContinues) {
                    const eventDetail = {
                        positionChange: { x: currentState.position.x - previousState.position.x, y: currentState.position.y - previousState.position.y },
                        spreadChange: currentState.spread - previousState.spread
                    };
                    if (currentState.touchCount == 2) this.el.emit("twofingermove", eventDetail);
                    else this.el.emit("onefingermove", eventDetail);
                }
                this.internalState.previousState = currentState;
            },
            getTouchState(event) {
                if (event.touches.length === 0) return null;
                const touchList = [];
                for (let i = 0; i < event.touches.length; i++) touchList.push(event.touches[i]);
                const touchCenter = touchList.reduce((acc, t) => ({ x: acc.x + t.clientX, y: acc.y + t.clientY }), { x: 0, y: 0 });
                touchCenter.x /= touchList.length; touchCenter.y /= touchList.length;
                const spread = touchList.length < 2 ? 0 : Math.sqrt(Math.pow(touchList[0].clientX - touchList[1].clientX, 2) + Math.pow(touchList[0].clientY - touchList[1].clientY, 2));
                return { touchCount: touchList.length, position: touchCenter, spread: spread };
            }
        });

        AFRAME.registerComponent("gesture-handler", {
            schema: { enabled: { default: true }, rotationFactor: { default: 5 }, minScale: { default: 0.1 }, maxScale: { default: 8 } },
            init: function() {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);
                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;
                this.el.sceneEl.addEventListener("markerFound", (e) => this.isVisible = true);
                this.el.sceneEl.addEventListener("markerLost", (e) => this.isVisible = false);
                this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
                this.el.sceneEl.addEventListener("onefingermove", this.handleRotation);
            },
            handleRotation: function(event) {
                if (this.isVisible) {
                    this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor * 0.005;
                    this.el.object3D.rotation.x += event.detail.positionChange.y * this.data.rotationFactor * 0.005;
                }
            },
            handleScale: function(event) {
                if (this.isVisible) {
                    this.scaleFactor *= 1 + event.detail.spreadChange / window.innerWidth;
                    this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);
                    this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
                    this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
                    this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
                }
            }
        });
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Kanit', sans-serif; background: black; }

        /* ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Video ‡∏ö‡∏ô iOS */
        video {
            position: absolute; top: 0; left: 0; z-index: -2 !important; 
            width: 100% !important; height: 100% !important; object-fit: cover !important;
        }

        /* --- 1. ‡∏´‡∏ô‡πâ‡∏≤ Home Screen --- */
        #home-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0b0f19 0%, #1a2a6c 50%, #b21f1f 100%);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .planet-icon { font-size: 100px; margin-bottom: 20px; animation: float 3s infinite; filter: drop-shadow(0 0 15px rgba(255,255,255,0.4)); }
        h1 { font-size: 2.5em; margin: 0; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); line-height: 1.2; }
        h2 { font-size: 1.2em; color: #ffcc00; font-weight: 300; margin: 10px 0 50px 0; }
        
        .btn-start {
            background: linear-gradient(90deg, #ff512f, #dd2476); color: white; border: none; padding: 18px 70px;
            font-size: 1.6em; font-family: 'Kanit', sans-serif; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(221, 36, 118, 0.5); animation: pulse 2s infinite; transition: all 0.3s ease;
        }
        .btn-start:hover { transform: scale(1.05); }

        /* --- 2. Loading Screen (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á Home, ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á) --- */
        #loading-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9000;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
            transition: opacity 0.5s ease;
        }
        .loader {
            border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid #00d2ff;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }

        /* --- 3. UI Overlay (‡∏Ç‡∏ì‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á) --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none; z-index: 1000;
        }
        .btn-back {
            pointer-events: auto; position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.9); color: #333; border: none; padding: 10px 20px;
            border-radius: 30px; font-family: 'Kanit', sans-serif; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .controls-hint {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            padding: 10px 30px; border-radius: 20px; color: white; font-size: 0.9em; border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(221, 36, 118, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="planet-icon">üåç</div>
        <h1>‡πÇ‡∏•‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</h1>
        <h2>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏ä‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2</h2>
        <button class="btn-start" onclick="startCamera()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
    </div>

    <div id="loading-layer">
        <div class="loader"></div>
        <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö AR...</div>
    </div>

    <div id="ui-layer">
        <button class="btn-back" onclick="stopCamera()">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <div class="controls-hint">üëÜ 1 ‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏°‡∏∏‡∏ô | ‚úåÔ∏è 2 ‡∏ô‡∏¥‡πâ‡∏ß‡∏ã‡∏π‡∏°</div>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 5;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights, antialias: true" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        gesture-detector>

        <a-assets>
            <a-asset-item id="model-earth" src="./eart.1blend.glb"></a-asset-item>
            <a-asset-item id="model-core" src="./_core2.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-entity 
                gltf-model="#model-core" 
                rotation="90 0 0" position="0 0 0" scale="0.5 0.5 0.5" 
                gesture-handler>
            </a-entity>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1">
            <a-entity 
                gltf-model="#model-earth" 
                rotation="90 0 0" position="0 0 0" scale="0.5 0.5 0.5" 
                gesture-handler>
            </a-entity>
        </a-entity>

    </a-scene>

    <script>
        const homeScreen = document.getElementById('home-screen');
        const loadingLayer = document.getElementById('loading-layer');
        const uiLayer = document.getElementById('ui-layer');
        const scene = document.querySelector('a-scene');

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
        let isARReady = false;

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö AR ‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß)
        scene.addEventListener('arReady', () => {
            isARReady = true;
            // ‡∏ñ‡πâ‡∏≤ User ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î Loading ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå UI ‡πÄ‡∏•‡∏¢
            if (loadingLayer.style.display === 'flex') {
                loadingLayer.style.opacity = '0';
                setTimeout(() => {
                    loadingLayer.style.display = 'none';
                    uiLayer.style.display = 'block';
                }, 500);
            }
        });

        function startCamera() {
            // 1. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Home ‡∏Ç‡∏∂‡πâ‡∏ô
            homeScreen.style.transform = 'translateY(-100%)';
            
            // 2. ‡∏ñ‡πâ‡∏≤ AR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå Loading ‡∏Å‡πà‡∏≠‡∏ô
            if (!isARReady) {
                loadingLayer.style.display = 'flex';
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏ä‡∏ß‡πå UI ‡πÄ‡∏•‡∏¢
                uiLayer.style.display = 'block';
            }
        }

        function stopCamera() {
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Home ‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏±‡∏ö
            homeScreen.style.transform = 'translateY(0%)';
            setTimeout(() => {
                uiLayer.style.display = 'none';
                loadingLayer.style.display = 'none';
                loadingLayer.style.opacity = '1'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ Opacity
            }, 500);
        }
    </script>
</body>
</html>